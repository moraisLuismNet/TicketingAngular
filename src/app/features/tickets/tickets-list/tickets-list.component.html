<div class="tickets-container">
  <div class="tickets-header">
    <div class="header-content">
      <h1>Tickets Management</h1>
    </div>
    @if (!authService.isAgent()) {
      <button class="btn btn-primary" (click)="openCreateTicket()">+ New Ticket</button>
    }
  </div>

  @if (isCreatingTicket) {
    <app-ticket-create
      (close)="closeCreateTicket()"
      (created)="onTicketCreated()">
    </app-ticket-create>
  }

  <div class="filters-bar">
    <div class="search-box">
      <input
        type="text"
        [(ngModel)]="searchTerm"
        (ngModelChange)="onSearchChange()"
        placeholder="Filter by title, user or date (MM/DD/YYYY)..."
        class="form-input"
      />
    </div>

    <div class="filter-group">
      <select
        [(ngModel)]="selectedStatus"
        (ngModelChange)="onStatusChange()"
        class="form-select"
      >
        <option value="">All Statuses</option>
        @for (s of ticketStatuses; track s.value) {
          <option [value]="s.value">{{ s.label }}</option>
        }
      </select>

      <select
        [(ngModel)]="selectedPriority"
        (ngModelChange)="onPriorityChange()"
        class="form-select"
      >
        <option value="">All Priorities</option>
        @for (p of ticketPriorities; track p.value) {
          <option [value]="p.value">{{ p.label }}</option>
        }
      </select>
    </div>


  </div>

  @if (isLoading) {
    <div class="loading-container">
      <div class="spinner"></div>
    </div>
  }

  @if (errorMessage) {
    <div class="alert alert-error">
      {{ errorMessage }}
    </div>
  }

  @if (!isLoading && !errorMessage) {
    <div class="tickets-table">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            @if (authService.isAgent()) {
              <th>User</th>
            }
            <th>Title</th>
            <th>Status</th>
            <th>Priority</th>
            @if (authService.isAgent()) {
              <th></th>
            }
          </tr>

        </thead>
        <tbody>
          @for (ticket of paginatedTickets; track ticket.id) {
            <tr
              (click)="selectTicket(ticket)"
              class="ticket-row"
              [class.selected]="selectedTicket?.id === ticket.id"
            >
              <td>{{ formatDate(ticket.createdAt) }}</td>
              @if (authService.isAgent()) {
                <td>
                  <div class="user-info">
                    <div class="user-name">{{ ticket.creatorName || 'Unknown' }}</div>
                    @if (ticket.creatorEmail) {
                      <div class="user-email">{{ ticket.creatorEmail }}</div>
                    }
                  </div>
                </td>
              }
              <td class="ticket-title">{{ ticket.title }}</td>
              <td>
                <span class="badge" [ngClass]="getStatusClass(ticket.status)">
                  {{ formatStatus(ticket.status) }}
                </span>
              </td>
              <td>
                <span class="badge" [ngClass]="getPriorityClass(ticket.priority)">
                  {{ formatPriority(ticket.priority) }}
                </span>
              </td>
              @if (authService.isAgent()) {
                <td>
                  @if (ticket.status === 0) {
                    <button
                      class="btn-assigned"
                      (click)="assignToMe($event, ticket)"
                    >
                      Assigned
                    </button>
                  }
                </td>
              }
            </tr>
          }
        </tbody>
      </table>

      @if (filteredTickets.length === 0) {
        <div class="empty-state">
          <p>No tickets found</p>
        </div>
      }

      <app-pagination
        [totalItems]="filteredTickets.length"
        [pageSize]="pageSize"
        [currentPage]="currentPage"
        (pageChange)="onPageChange($event)">
      </app-pagination>
    </div>
  }

  @if (selectedTicket) {
    <app-ticket-detail
      [ticket]="selectedTicket"
      (close)="closeTicketDetail()"
      (ticketUpdated)="onTicketUpdated()"
    ></app-ticket-detail>
  }
</div>
